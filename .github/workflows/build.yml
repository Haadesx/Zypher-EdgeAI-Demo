# Zephyr Edge AI Demo - GitHub Actions CI

name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ZEPHYR_SDK_VERSION: 0.16.5

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: zephyr-edge-ai-demo
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache west packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          bootloader
          modules
          tools
          zephyr
        key: ${{ runner.os }}-west-${{ hashFiles('**/west.yml') }}
        restore-keys: |
          ${{ runner.os }}-west-
    
    - name: Cache Zephyr SDK
      uses: actions/cache@v4
      with:
        path: ~/.local/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}
        key: ${{ runner.os }}-sdk-${{ env.ZEPHYR_SDK_VERSION }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build gperf \
          ccache dfu-util device-tree-compiler wget \
          python3-dev python3-pip python3-setuptools python3-wheel \
          xz-utils file make gcc gcc-multilib g++-multilib \
          libsdl2-dev
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install west
    
    - name: Initialize west workspace
      run: |
        west init -l zephyr-edge-ai-demo
        west update --narrow -o=--depth=1
    
    - name: Export CMake package
      run: west zephyr-export
    
    - name: Install Zephyr Python requirements
      run: |
        pip install -r zephyr/scripts/requirements.txt
    
    - name: Install Zephyr SDK
      run: |
        if [ ! -d ~/.local/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }} ]; then
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${{ env.ZEPHYR_SDK_VERSION }}/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64.tar.xz
          tar xf zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64.tar.xz -C ~/.local/
          ~/.local/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}/setup.sh -t arm-zephyr-eabi -h
        fi
    
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ runner.os }}-ccache-mps2
    
    - name: Build for mps2/an385
      run: |
        export ZEPHYR_SDK_INSTALL_DIR=~/.local/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}
        export PATH="/usr/lib/ccache:$PATH"
        cd zephyr-edge-ai-demo
        west build -b mps2/an385 -p always
      env:
        CCACHE_DIR: ~/.ccache
    
    - name: Generate size report
      run: |
        cd zephyr-edge-ai-demo
        west build -t ram_report > ram_report.txt
        west build -t rom_report > rom_report.txt
        echo "## RAM Report" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        head -50 ram_report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "## ROM Report" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        head -50 rom_report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          zephyr-edge-ai-demo/build/zephyr/zephyr.elf
          zephyr-edge-ai-demo/build/zephyr/zephyr.bin
          zephyr-edge-ai-demo/ram_report.txt
          zephyr-edge-ai-demo/rom_report.txt
    
    - name: Run QEMU smoke test
      run: |
        cd zephyr-edge-ai-demo
        timeout 10 west build -t run || true
      continue-on-error: true

  lint:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linters
      run: |
        pip install --upgrade pip
        pip install flake8 pylint
    
    - name: Lint Python scripts
      continue-on-error: true
      run: |
        flake8 scripts/ --max-line-length=100 --ignore=E501,W503,W504,E226,E302,E303
    
    - name: Check C formatting hints
      run: |
        # Basic check for common issues
        find src -name '*.c' -o -name '*.h' | xargs grep -l 'TODO\|FIXME\|XXX' || echo "No TODO markers found"
